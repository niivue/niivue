<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="niivue.css" />
    <title>CACTUS</title>
  </head>
  <body>
    <header>
      <div class="dropdown">
        <button class="dropbtn">
          File
          <i class="fa fa-caret-down"></i>
        </button>
        <div class="dropdown-content">
          <a class="viewBtn" id="SaveDraw" accesskey="s">Save Drawing ^S</a>
          <a class="viewBtn" id="SaveBitmap">Screen Shot</a>
          <a class="viewBtn" id="ShowHeader">Show Header</a>
          <a class="linker" href="https://github.com/mpsych/CACTAS"
            >About CACTUS</a
          >
        </div>
      </div>
      <div class="dropdown">
        <button class="dropbtn">
          Edit
          <i class="fa fa-caret-down"></i>
        </button>
        <div class="dropdown-content">
          <a class="viewBtn" id="Undo" accesskey="z">Undo Draw ^Z</a>
        </div>
      </div>
      <div class="dropdown">
        <button class="dropbtn" data-toggle="dropdown">
          View
          <i class="fa fa-caret-down"></i>
        </button>
        <div class="dropdown-content">
          <a href="#" class="viewBtn" id="|Axial">Axial</a>
          <a class="viewBtn" id="|Sagittal">Sagittal</a>
          <a class="viewBtn" id="|Coronal">Coronal</a>
          <a class="viewBtn" id="|Render">Render</a>
          <a class="viewBtn" id="|MultiPlanar">A+C+S</a>
          <a class="viewBtn dropdown-item-checked" id="|MultiPlanarRender"
            >A+C+S+R</a
          >
          <a class="viewBtn divider dropdown-item-checked" id="Colorbar"
            >Colorbar</a
          >
          <a class="viewBtn" id="Radiological">Radiological</a>
          <a class="viewBtn dropdown-item-checked" id="Crosshair"
            >Render Crosshair</a
          >
          <a class="viewBtn" id="ClipPlane">Render Clip Plane</a>
          <a class="viewBtn dropdown-item-checked" id="WorldSpace"
            >World Space</a
          >
          <a class="viewBtn dropdown-item-checked" id="Interpolate"
            >Smooth Interpolation</a
          >
          <a class="viewBtn" id="RemoveHaze">Remove Haze</a>
          <a class="viewBtn divider" id="Left">Left</a>
          <a class="viewBtn" id="Right">Right</a>
          <a class="viewBtn" id="Anterior">Anterior</a>
          <a class="viewBtn" id="Posterior">Posterior</a>
          <a class="viewBtn" id="Inferior">Inferior</a>
          <a class="viewBtn" id="Superior">Superior</a>
        </div>
      </div>
      <div class="dropdown">
        <button class="dropbtn">
          Color
          <i class="fa fa-caret-down"></i>
        </button>
        <div class="dropdown-content">
          <a class="viewBtn" id="!ct_artery">ct_artery</a>
          <a class="viewBtn dropdown-item-checked" id="!ct_airways"
            >ct_airways</a
          >
          <a class="viewBtn" id="!ct_kidneys">ct_kidneys</a>
          <a class="viewBtn" id="!ct_bones">ct_bones</a>
          <a class="viewBtn divider dropdown-item-checked" id="BackColor"
            >Dark Background</a
          >
        </div>
      </div>
      <div class="dropdown">
        <button class="dropbtn">
          Draw
          <i class="fa fa-caret-down"></i>
        </button>
        <div class="dropdown-content">
          <a class="viewBtn" id="@Off" accesskey="0">Off ^0</a>
          <a class="viewBtn" id="@Red" accesskey="1">Red ^1</a>
          <a class="viewBtn" id="@Green" accesskey="2">Green ^2</a>
          <a class="viewBtn" id="@Blue" accesskey="3">Blue ^3</a>
          <a class="viewBtn" id="@Yellow" accesskey="4">Yellow ^4</a>
          <a class="viewBtn" id="@Cyan" accesskey="5">Cyan ^5</a>
          <a class="viewBtn" id="@Purple" accesskey="6">Purple ^6</a>
          <a class="viewBtn" id="@Erase" accesskey="4">Erase ^7</a>
          <a class="viewBtn" id="@Cluster" accesskey="5">Erase Cluster ^8</a>
          <a class="viewBtn dropdown-item-checked" id="@SelectCluster"
            >Create Green Cluster</a
          >
          <a
            class="viewBtn divider dropdown-item-checked"
            id="DrawFilled"
            accesskey="f"
            >Fill Outline ^F</a
          >
          <a
            class="viewBtn dropdown-item-checked"
            id="DrawOverwrite"
            accesskey="o"
            >Pen Overwrites Existing ^O</a
          >
          <a
            class="viewBtn dropdown-item-checked"
            id="Translucent"
            accesskey="t"
            >Translucent ^T</a
          >
          <a class="viewBtn" id="Growcut">Grow Cut</a>
          <a class="viewBtn" id="DrawOtsu">Otsu</a>
        </div>
      </div>
      <div class="dropdown">
        <button class="dropbtn">
          Drag
          <i class="fa fa-caret-down"></i>
        </button>
        <div class="dropdown-content">
          <a class="viewBtn" id="^contrast">Contrast</a>
          <a class="viewBtn" id="^measurement">Measurement</a>
          <a class="viewBtn" id="^pan">Pan/Zoom</a>
          <a class="viewBtn dropdown-item-checked" id="^slicer">Slicer3D</a>
          <a class="viewBtn" id="^none">None</a>
        </div>
      </div>
    </header>
    <main id="container">
      <canvas id="gl1"></canvas>
    </main>
    <footer id="intensity">&nbsp</footer>
  </body>
</html>
<script type="module" async>
  import * as niivue from "./niivue.es.js";
  var isFilled = true;
  var isCustomDraw = true;
  var lastPos = null;
  document.getElementById("gl1").ondblclick = async function () {
    if (!isCustomDraw) return;
    if (!lastPos) return;
    if (!lastPos.hasOwn("values")) return;
    if (!nv1.drawBitmap) nv1.createEmptyDrawing();
    if (!isFinite(lastPos.axCorSag)) return;
    if (lastPos.axCorSag < 0 || lastPos.axCorSag > 2) return;
    let penValue = 2; //green
    let threshold_tolerance = 450;
    let intensity = lastPos.values[0].value;
    let mn = intensity - threshold_tolerance;
    let mx = intensity + threshold_tolerance;
    let min_threshold_tolerance = 300;
    if (mn < min_threshold_tolerance) {
      console.log("Hounsfield Intensity too dark to be plaque");
      if (mx < min_threshold_tolerance) return;
      mn = Math.max(mn, min_threshold_tolerance);
    }
    nv1.drawPt(...lastPos.vox, penValue);
    await nv1.drawFloodFill(lastPos.vox, 0, 1, mn, mx);
    nv1.refreshDrawing(true);
  };
  function handleIntensityChange(data) {
    document.getElementById("intensity").innerHTML =
      "&nbsp;&nbsp;" + data.string;
    lastPos = data;
  }
  var nv1 = new niivue.Niivue({
    logging: true,
    dragAndDropEnabled: true,
    backColor: [0, 0, 0, 1],
    show3Dcrosshair: true,
    onLocationChange: handleIntensityChange,
  });
  nv1.opts.isColorbar = false;
  nv1.setRadiologicalConvention(false);
  nv1.attachTo("gl1");
  nv1.setRenderAzimuthElevation(120, 10);
  nv1.setSliceType(nv1.sliceTypeMultiplanar);
  nv1.setSliceMM(true);
  nv1.opts.multiplanarForceRender = false;
  nv1.graph.autoSizeMultiplanar = true;
  nv1.graph.opacity = 1.0;
  nv1.drawOpacity = 0.5;
  nv1.opts.isColorbar = false;
  nv1.opts.multiplanarForceRender = true;
  var volumeList1 = [{ url: "../images/cactus.nii.gz" }];
  await nv1.loadVolumes(volumeList1);
  //image specific settings
  nv1.volumes[0].colormap = "ct_kidneys";
  nv1.volumes[0].cal_min = 80;
  nv1.volumes[0].cal_max = 480;
  nv1.opts.dragMode = nv1.dragModes.slicer3D;
  nv1.setRenderAzimuthElevation(220, -20);
  nv1.scene.crosshairPos = [0.68, 0.275, 0.086];
  nv1.updateGLVolume();
  //handle menus
  function toggleGroup(id) {
    let buttons = document.getElementsByClassName("viewBtn");
    let char0 = id.charAt(0);
    for (let i = 0; i < buttons.length; i++) {
      if (buttons[i].id.charAt(0) !== char0) continue;
      buttons[i].classList.remove("dropdown-item-checked");
      if (buttons[i].id === id)
        buttons[i].classList.add("dropdown-item-checked");
    }
  } // toggleGroup()
  async function onButtonClick(event) {
    if (event.target.id === "SaveDraw") {
      nv1.saveImage("draw.nii", true);
      return;
    }
    if (event.target.id === "SaveBitmap") {
      nv1.saveScene("ScreenShot.png");
      return;
    }
    if (event.target.id === "ShowHeader") {
      alert(nv1.volumes[0].hdr.toFormattedString());
      return;
    }
    if (event.target.id === "Colorbar") {
      nv1.opts.isColorbar = !nv1.opts.isColorbar;
      event.srcElement.classList.toggle("dropdown-item-checked");
      nv1.drawScene();
      return;
    }
    if (event.target.id === "Radiological") {
      nv1.opts.isRadiologicalConvention = !nv1.opts.isRadiologicalConvention;
      event.srcElement.classList.toggle("dropdown-item-checked");
      nv1.drawScene();
      return;
    }
    if (event.target.id === "Crosshair") {
      nv1.opts.show3Dcrosshair = !nv1.opts.show3Dcrosshair;
      event.srcElement.classList.toggle("dropdown-item-checked");
      nv1.drawScene();
    }
    if (event.target.id === "ClipPlane") {
      if (nv1.scene.clipPlaneDepthAziElev[0] > 1)
        nv1.setClipPlane([0.3, 270, 0]);
      else nv1.setClipPlane([2, 270, 0]);
      nv1.drawScene();
      return;
    }
    if (event.target.id.charAt(0) === "!") {
      // set color scheme
      nv1.volumes[0].colormap = event.target.id.substr(1);
      nv1.updateGLVolume();
      toggleGroup(event.target.id);
      return;
    }
    if (event.target.id === "Undo") {
      nv1.drawUndo();
    }
    if (event.target.id.charAt(0) === "@") {
      //sliceType
      isCustomDraw = false;
      if (event.target.id === "@Off") nv1.setDrawingEnabled(false);
      else nv1.setDrawingEnabled(true);
      if (event.target.id === "@Erase") nv1.setPenValue(0, isFilled);
      if (event.target.id === "@Red") nv1.setPenValue(1, isFilled);
      if (event.target.id === "@Green") nv1.setPenValue(2, isFilled);
      if (event.target.id === "@Blue") nv1.setPenValue(3, isFilled);
      if (event.target.id === "@Yellow") nv1.setPenValue(4, isFilled);
      if (event.target.id === "@Cyan") nv1.setPenValue(5, isFilled);
      if (event.target.id === "@Purple") nv1.setPenValue(6, isFilled);
      if (event.target.id === "@Cluster") nv1.setPenValue(-0, isFilled);
      if (event.target.id === "@SelectCluster") {
        //custom
        nv1.setDrawingEnabled(false);
        isCustomDraw = true;
      }
      toggleGroup(event.target.id);
    } //Draw Color
    if (event.target.id === "Growcut") nv1.drawGrowCut();
    if (event.target.id === "Translucent") {
      if (nv1.drawOpacity > 0.75) nv1.drawOpacity = 0.5;
      else nv1.drawOpacity = 1.0;
      nv1.drawScene();
      event.srcElement.classList.toggle("dropdown-item-checked");
      return;
    }
    if (event.target.id === "DrawOtsu") {
      let levels = parseInt(prompt("Segmentation classes (2..4)", "3"));
      nv1.drawOtsu(levels);
    }
    if (event.target.id === "RemoveHaze") {
      let level = parseInt(prompt("Remove Haze (1..5)", "5"));
      nv1.removeHaze(level);
    }
    if (event.target.id === "DrawFilled") {
      isFilled = !isFilled;
      nv1.setPenValue(nv1.opts.penValue, isFilled);
      event.srcElement.classList.toggle("dropdown-item-checked");
      return;
    }
    if (event.target.id === "DrawOverwrite") {
      nv1.drawFillOverwrites = !nv1.drawFillOverwrites;
      event.srcElement.classList.toggle("dropdown-item-checked");
      return;
    }
    if (event.target.id.charAt(0) === "|") {
      //sliceType
      if (event.target.id === "|Axial") nv1.setSliceType(nv1.sliceTypeAxial);
      if (event.target.id === "|Coronal")
        nv1.setSliceType(nv1.sliceTypeCoronal);
      if (event.target.id === "|Sagittal")
        nv1.setSliceType(nv1.sliceTypeSagittal);
      if (event.target.id === "|Render") nv1.setSliceType(nv1.sliceTypeRender);
      if (event.target.id === "|MultiPlanar") {
        nv1.opts.multiplanarForceRender = false;
        nv1.setSliceType(nv1.sliceTypeMultiplanar);
      }
      if (event.target.id === "|MultiPlanarRender") {
        nv1.opts.multiplanarForceRender = true;
        nv1.setSliceType(nv1.sliceTypeMultiplanar);
      }
      toggleGroup(event.target.id);
    } //sliceType
    if (event.target.id === "WorldSpace") {
      nv1.setSliceMM(!nv1.opts.isSliceMM);
      event.srcElement.classList.toggle("dropdown-item-checked");
      return;
    }
    if (event.target.id === "Interpolate") {
      nv1.setInterpolation(!nv1.opts.isNearestInterpolation);
      event.srcElement.classList.toggle("dropdown-item-checked");
      return;
    }
    if (event.target.id === "Left") nv1.moveCrosshairInVox(-1, 0, 0);
    if (event.target.id === "Right") nv1.moveCrosshairInVox(1, 0, 0);
    if (event.target.id === "Posterior") nv1.moveCrosshairInVox(0, -1, 0);
    if (event.target.id === "Anterior") nv1.moveCrosshairInVox(0, 1, 0);
    if (event.target.id === "Inferior") nv1.moveCrosshairInVox(0, 0, -1);
    if (event.target.id === "Superior") nv1.moveCrosshairInVox(0, 0, 1);
    if (event.target.id === "BackColor") {
      if (nv1.opts.backColor[0] < 0.5) nv1.opts.backColor = [1, 1, 1, 1];
      else nv1.opts.backColor = [0, 0, 0, 1];
      nv1.drawScene();
      event.srcElement.classList.toggle("dropdown-item-checked");
      return;
    }
    if (event.target.id.charAt(0) === "^") {
      //drag mode
      let s = event.target.id.substr(1);
      switch (s) {
        case "none":
          nv1.opts.dragMode = nv1.dragModes.none;
          break;
        case "contrast":
          nv1.opts.dragMode = nv1.dragModes.contrast;
          break;
        case "measurement":
          nv1.opts.dragMode = nv1.dragModes.measurement;
          break;
        case "pan":
          nv1.opts.dragMode = nv1.dragModes.pan;
          break;
        case "slicer":
          nv1.opts.dragMode = nv1.dragModes.slicer3D;
          break;
      }
      toggleGroup(event.target.id);
    } //drag mode
  } // onButtonClick()
  var buttons = document.getElementsByClassName("viewBtn");
  for (let i = 0; i < buttons.length; i++)
    buttons[i].addEventListener("click", onButtonClick, false);
</script>
