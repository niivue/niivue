<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0" />
    <title>NiiVue - Pyramidal TIFF Viewer</title>
    <link rel="stylesheet" href="niivue.css" />
    <link rel="icon" href="data:;base64,iVBORw0KGgo=" />
    <style>
      #controls {
        display: flex;
        gap: 16px;
        align-items: center;
        padding: 8px;
        background: #2a2a2a;
      }
      #controls label {
        color: #ccc;
      }
      #controls input, #controls select {
        padding: 4px 8px;
      }
      #loadBtn {
        background: #4a9eff;
        border: none;
        color: white;
        padding: 8px 16px;
        cursor: pointer;
        border-radius: 4px;
      }
      #loadBtn:hover {
        background: #3a8eef;
      }
      #progressContainer {
        display: none;
        align-items: center;
        gap: 8px;
      }
      #progressBar {
        width: 100px;
        height: 8px;
      }
    </style>
  </head>
  <body>
    <header>
      <div id="controls">
        <label for="serverUrl">Server URL:</label>
        <input type="text" id="serverUrl" value="http://localhost:3000" style="width: 200px" />

        <label for="imageName">Image:</label>
        <input type="text" id="imageName" value="E25417_25-1S.1.ome.tif" style="width: 150px" />

        <button id="loadBtn">Load TIFF</button>

        <div id="progressContainer">
          <progress id="progressBar" value="0" max="100"></progress>
          <span id="progressText">0%</span>
        </div>
      </div>
    </header>
    <main id="canvas-container">
      <div style="display: flex; width: 100%; height: 100%">
        <canvas id="gl1"></canvas>
      </div>
    </main>
    <footer>
      <label id="statusBar">Use shift+scroll to change pyramid level | Drag to pan | Scroll to zoom</label>
    </footer>
  </body>
</html>
<script type="module" async>
  import { Niivue, DRAG_MODE, SLICE_TYPE } from './niivue/index.ts'

  const serverUrlInput = document.getElementById('serverUrl')
  const imageNameInput = document.getElementById('imageName')
  const loadBtn = document.getElementById('loadBtn')
  const progressContainer = document.getElementById('progressContainer')
  const progressBar = document.getElementById('progressBar')
  const progressText = document.getElementById('progressText')
  const statusBar = document.getElementById('statusBar')

  // Create NiiVue instance with callbacks
  const nv = new Niivue({
    logLevel: 'debug',
    dragMode: DRAG_MODE.pan,
    isColorbar: false,
    isOrientCube: false,
    backColor: [0.1, 0.1, 0.15, 1],
    onPyramidLevelChange: (info) => {
      statusBar.textContent = `Level ${info.level + 1}/${info.totalLevels} (${info.levelWidth} x ${info.levelHeight}) | Shift+scroll: change level | Drag: pan | Scroll: zoom`
    },
    onTileLoadProgress: (info) => {
      const percent = Math.round((info.tilesLoaded / info.tilesTotal) * 100)
      progressBar.value = percent
      progressText.textContent = `${percent}%`

      if (info.tilesLoaded >= info.tilesTotal) {
        // Hide progress after brief delay
        setTimeout(() => {
          progressContainer.style.display = 'none'
        }, 500)
      }
    }
  })

  // Attach to canvas
  await nv.attachToCanvas(document.getElementById('gl1'))

  // Load button handler
  loadBtn.addEventListener('click', async () => {
    const serverUrl = serverUrlInput.value.trim()
    const imageName = imageNameInput.value.trim()

    if (!serverUrl || !imageName) {
      alert('Please enter both server URL and image name')
      return
    }

    loadBtn.disabled = true
    loadBtn.textContent = 'Loading...'
    progressContainer.style.display = 'flex'
    progressBar.value = 0
    progressText.textContent = '0%'

    try {
      await nv.loadTiffFromServer(serverUrl, imageName)

      // Update status with pyramid info
      if (nv.tiffImage) {
        const info = nv.tiffImage.getPyramidInfo()
        const level = nv.tiffImage.getPyramidLevel()
        const levelInfo = info.levels[level]
        statusBar.textContent = `Level ${level + 1}/${info.levels.length} (${levelInfo.width} x ${levelInfo.height}) | Shift+scroll: change level | Drag: pan | Scroll: zoom`
      }
    } catch (err) {
      console.error('Failed to load TIFF:', err)
      statusBar.textContent = `Error: ${err.message}`
      progressContainer.style.display = 'none'
    } finally {
      loadBtn.disabled = false
      loadBtn.textContent = 'Load TIFF'
    }
  })

  // Keyboard shortcut info
  console.log(`
  Pyramidal TIFF Viewer Controls:
  - Shift + Mouse Wheel: Change pyramid level (resolution)
  - Mouse Wheel: Zoom in/out within current level
  - Click + Drag: Pan the view
  `)
</script>
