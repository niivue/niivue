<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0" />
    <title>NiiVue - Zarr Viewer (Unified Zoom)</title>
    <link rel="stylesheet" href="niivue.css" />
    <link rel="icon" href="data:;base64,iVBORw0KGgo=" />
    <style>
      #controls {
        display: flex;
        gap: 16px;
        align-items: center;
        padding: 8px;
        background: #2a2a2a;
        flex-wrap: wrap;
      }
      #controls label {
        color: #ccc;
      }
      #controls input,
      #controls select {
        padding: 4px 8px;
      }
      #loadBtn {
        background: #4a9eff;
        border: none;
        color: white;
        padding: 8px 16px;
        cursor: pointer;
        border-radius: 4px;
      }
      #loadBtn:hover {
        background: #3a8eef;
      }
      #loadBtn:disabled {
        background: #666;
        cursor: not-allowed;
      }
      #progressContainer {
        display: none;
        align-items: center;
        gap: 8px;
      }
      #progressBar {
        width: 100px;
        height: 8px;
      }
      #navControls {
        display: none;
        gap: 8px;
        align-items: center;
      }
      #navControls button {
        background: #444;
        border: 1px solid #666;
        color: white;
        padding: 4px 12px;
        cursor: pointer;
        border-radius: 4px;
      }
      #navControls button:hover {
        background: #555;
      }
      #infoPanel {
        padding: 8px;
        background: #1a1a2e;
        color: #aaa;
        font-family: monospace;
        font-size: 12px;
        display: none;
      }
      .hint {
        color: #888;
        font-size: 11px;
        font-style: italic;
      }
    </style>
  </head>
  <body>
    <header>
      <div id="controls">
        <label for="storeUrl">Zarr URL:</label>
        <input
          type="text"
          id="storeUrl"
          value="https://ome-zarr-scivis.s3.us-east-1.amazonaws.com/v0.5/96x2/present.ome.zarr"
          style="width: 400px"
        />

        <label for="maxVolSize">Max Volume Size:</label>
        <select id="maxVolSize">
          <option value="128">128</option>
          <option value="256" selected>256</option>
          <option value="512">512</option>
        </select>

        <button id="loadBtn">Load Zarr</button>

        <div id="progressContainer">
          <progress id="progressBar" value="0" max="100"></progress>
          <span id="progressText">0%</span>
        </div>

        <div id="navControls">
          <span class="hint">Scroll to zoom, drag to pan</span>
          <label for="levelSelect">Manual level:</label>
          <select id="levelSelect"></select>
        </div>
      </div>
    </header>
    <div id="infoPanel"></div>
    <main id="canvas-container">
      <div style="display: flex; width: 100%; height: 100%">
        <canvas id="gl1"></canvas>
      </div>
    </main>
    <footer>
      <label id="statusBar">Enter a zarr store URL and click Load</label>
    </footer>
  </body>
</html>
<script type="module" async>
  import { Niivue, DRAG_MODE, SLICE_TYPE, SHOW_RENDER } from './niivue/index.ts'

  const storeUrlInput = document.getElementById('storeUrl')
  const maxVolSizeSelect = document.getElementById('maxVolSize')
  const loadBtn = document.getElementById('loadBtn')
  const progressContainer = document.getElementById('progressContainer')
  const progressBar = document.getElementById('progressBar')
  const progressText = document.getElementById('progressText')
  const statusBar = document.getElementById('statusBar')
  const navControls = document.getElementById('navControls')
  const infoPanel = document.getElementById('infoPanel')
  const levelSelect = document.getElementById('levelSelect')

  // Create NiiVue instance
  const nv = new Niivue({
    logLevel: 'debug',
    dragMode: DRAG_MODE.pan,
    isColorbar: true,
    isOrientCube: true,
    backColor: [0.1, 0.1, 0.15, 1],
    onZarrLevelChange: (info) => {
      let status = `Level ${info.level + 1}/${info.totalLevels} (${info.levelWidth} x ${info.levelHeight}`
      if (info.levelDepth && info.levelDepth > 1) {
        status += ` x ${info.levelDepth}`
      }
      status += ') - Auto'
      statusBar.textContent = status

      // Update level selector to match auto-selected level
      levelSelect.value = info.level

      updateInfoPanel()
    },
    onZarrChunkLoadProgress: (info) => {
      const percent = Math.round((info.chunksLoaded / info.chunksTotal) * 100)
      progressBar.value = percent
      progressText.textContent = `${percent}%`

      if (info.chunksLoaded >= info.chunksTotal) {
        setTimeout(() => {
          progressContainer.style.display = 'none'
        }, 500)
      }
    }
  })

  // Attach to canvas
  await nv.attachToCanvas(document.getElementById('gl1'))
  nv.opts.multiplanarShowRender = SHOW_RENDER.ALWAYS

  // Update info panel with current viewport state
  function updateInfoPanel() {
    if (!nv.zarrImage) {
      infoPanel.style.display = 'none'
      return
    }

    const state = nv.zarrImage.getViewportState()
    const pyramidInfo = nv.zarrImage.getPyramidInfo()
    const volDims = nv.zarrImage.getVolumeDimensions()

    const level0Dims = pyramidInfo.levels[0].shape
    const currentLevel = pyramidInfo.levels[state.pyramidLevel]

    const wasHidden = infoPanel.style.display === 'none' || infoPanel.style.display === ''
    infoPanel.style.display = 'block'
    infoPanel.innerHTML = `
      <strong>Dataset:</strong> ${pyramidInfo.name}<br>
      <strong>Full size:</strong> ${level0Dims.join(' x ')} (${pyramidInfo.is3D ? '3D' : '2D'})<br>
      <strong>Pyramid levels:</strong> ${pyramidInfo.levels.length}<br>
      <strong>Current level:</strong> ${state.pyramidLevel} (${currentLevel.shape.join(' x ')})<br>
      <strong>Zoom:</strong> ${state.zoom.toFixed(2)}x<br>
      <strong>Center (Level 0):</strong> X=${state.centerX.toFixed(1)}, Y=${state.centerY.toFixed(1)}, Z=${state.centerZ.toFixed(1)}<br>
      <strong>Virtual volume:</strong> ${volDims.width} x ${volDims.height} x ${volDims.depth}
    `
    // Notify NiiVue of layout change so mouse coordinates are recalculated
    if (wasHidden) {
      nv.resizeListener()
    }
  }

  // Manual level select handler (for testing/debugging)
  levelSelect.addEventListener('change', async () => {
    if (!nv.zarrImage) return
    const level = parseInt(levelSelect.value)
    await nv.zarrImage.setPyramidLevel(level)
    nv.updateGLVolume()
    nv.drawScene()
    updateInfoPanel()
  })

  // Load button handler
  loadBtn.addEventListener('click', async () => {
    const storeUrl = storeUrlInput.value.trim()
    if (!storeUrl) {
      alert('Please enter a zarr store URL')
      return
    }

    const maxVolSize = parseInt(maxVolSizeSelect.value)

    loadBtn.disabled = true
    loadBtn.textContent = 'Loading...'
    progressContainer.style.display = 'flex'
    progressBar.value = 0
    progressText.textContent = '0%'
    statusBar.textContent = 'Discovering zarr structure...'

    try {
      await nv.loadZarrFromServer(storeUrl, {
        maxVolumeSize: maxVolSize,
      })
      nv.setColormap(nv.volumes[0].id)

      // Show navigation controls
      navControls.style.display = 'flex'

      // Populate level selector
      if (nv.zarrImage) {
        const pyramidInfo = nv.zarrImage.getPyramidInfo()
        levelSelect.innerHTML = ''
        pyramidInfo.levels.forEach((level, idx) => {
          const option = document.createElement('option')
          option.value = idx
          option.textContent = `${idx}: ${level.shape.join('x')}`
          if (idx === nv.zarrImage.getPyramidLevel()) {
            option.selected = true
          }
          levelSelect.appendChild(option)
        })

        // Update status and info
        const state = nv.zarrImage.getViewportState()
        const dims = pyramidInfo.levels[state.pyramidLevel].shape
        statusBar.textContent = `Level ${state.pyramidLevel + 1}/${pyramidInfo.levels.length} (${dims.join(' x ')})`
        updateInfoPanel()
      }
    } catch (err) {
      console.error('Failed to load Zarr:', err)
      statusBar.textContent = `Error: ${err.message}`
      progressContainer.style.display = 'none'
      navControls.style.display = 'none'
      infoPanel.style.display = 'none'
    } finally {
      loadBtn.disabled = false
      loadBtn.textContent = 'Load Zarr'
    }
  })

  console.log(`
  Zarr Viewer (Unified Zoom) Controls:
  - Mouse wheel: Zoom in/out (automatically selects pyramid level)
  - Left-click drag: Pan the view
  - Level dropdown: Manual level override (for debugging)
  - NiiVue standard controls for slice navigation

  The zoom system follows the TIFF pattern:
  - All coordinates are in Level 0 (full resolution) space
  - Virtual volume size is FIXED - data is scaled to fill it
  - Smooth zooming with automatic level selection via hysteresis
  `)
</script>
