<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0" />
    <title>NiiVue - Zarr Viewer</title>
    <link rel="stylesheet" href="niivue.css" />
    <link rel="icon" href="data:;base64,iVBORw0KGgo=" />
    <style>
      #controls {
        display: flex;
        gap: 16px;
        align-items: center;
        padding: 8px;
        background: #2a2a2a;
        flex-wrap: wrap;
      }
      #controls label {
        color: #ccc;
      }
      #controls input,
      #controls select {
        padding: 4px 8px;
      }
      #loadBtn {
        background: #4a9eff;
        border: none;
        color: white;
        padding: 8px 16px;
        cursor: pointer;
        border-radius: 4px;
      }
      #loadBtn:hover {
        background: #3a8eef;
      }
      #loadBtn:disabled {
        background: #666;
        cursor: not-allowed;
      }
      #navControls {
        display: none;
        gap: 8px;
        align-items: center;
      }
      #navControls button {
        background: #444;
        border: 1px solid #666;
        color: white;
        padding: 4px 12px;
        cursor: pointer;
        border-radius: 4px;
      }
      #navControls button:hover {
        background: #555;
      }
      #levelSelectorsContainer {
        display: flex;
        gap: 16px;
        flex-wrap: wrap;
        align-items: center;
      }
      .level-selector {
        display: flex;
        gap: 4px;
        align-items: center;
        background: #333;
        padding: 4px 8px;
        border-radius: 4px;
      }
      .level-selector label {
        color: #aaa;
        font-size: 11px;
      }
      .level-selector select {
        padding: 2px 4px;
      }
      #infoPanel {
        padding: 8px;
        background: #1a1a2e;
        color: #aaa;
        font-family: monospace;
        font-size: 12px;
        display: none;
      }
      .hint {
        color: #888;
        font-size: 11px;
        font-style: italic;
      }
      #affineControls {
        display: none;
        padding: 8px 12px;
        background: #1e1e2e;
        border-top: 1px solid #333;
      }
      #affineControls h3 {
        color: #ccc;
        margin: 0 0 8px 0;
        font-size: 13px;
        display: flex;
        align-items: center;
        gap: 12px;
      }
      #affineControls h3 button {
        background: #c44;
        border: none;
        color: white;
        padding: 2px 10px;
        cursor: pointer;
        border-radius: 3px;
        font-size: 11px;
      }
      #affineControls h3 button:hover {
        background: #d55;
      }
      #affineSaveBtn, #affineLoadBtn {
        background: #4a9eff !important;
      }
      #affineSaveBtn:hover, #affineLoadBtn:hover {
        background: #3a8eef !important;
      }
      .affine-group {
        display: flex;
        gap: 16px;
        flex-wrap: wrap;
        margin-bottom: 4px;
      }
      .affine-group label {
        color: #999;
        font-size: 11px;
        font-family: monospace;
      }
      .affine-slider {
        display: flex;
        align-items: center;
        gap: 6px;
      }
      .affine-slider input[type="range"] {
        width: 120px;
      }
      .affine-slider .val {
        color: #6cf;
        font-family: monospace;
        font-size: 11px;
        min-width: 50px;
        text-align: right;
      }
    </style>
  </head>
  <body>
    <header>
      <div id="controls">
        <label for="storeUrl">Zarr URL:</label>
        <input
          type="text"
          id="storeUrl"
          value="https://ome-zarr-scivis.s3.us-east-1.amazonaws.com/v0.5/96x2/pawpawsaurus.ome.zarr"
          style="width: 400px"
        />
        <!-- https://ome-zarr-scivis.s3.us-east-1.amazonaws.com/v0.5/96x2/pawpawsaurus.ome.zarr -->
         <!-- https://ome-zarr-scivis.s3.us-east-1.amazonaws.com/v0.5/96x2/chameleon.ome.zarr -->

        <label for="maxVolSize">Max Volume Size:</label>
        <select id="maxVolSize">
          <option value="128">128</option>
          <option value="256" selected>256</option>
          <option value="512">512</option>
        </select>

        <label for="zarrLevel">Level:</label>
        <select id="zarrLevel">
          <option value="0" selected>0 (highest res)</option>
          <option value="1">1</option>
          <option value="2">2</option>
          <option value="3">3</option>
          <option value="4">4</option>
          <option value="5">5</option>
        </select>

        <button id="loadBtn">Load Zarr</button>

        <div id="navControls">
          <span class="hint">Drag to pan</span>
          <div id="levelSelectorsContainer"></div>
        </div>
      </div>
    </header>
    <div id="infoPanel"></div>
    <div id="affineControls">
      <h3>
        Registration Controls (Zarr Volume)
        <button id="affineResetBtn">Reset</button>
        <button id="affineSaveBtn">Save</button>
        <button id="affineLoadBtn">Load</button>
      </h3>
      <div class="affine-group">
        <label>Translate (mm):</label>
        <div class="affine-slider">
          <label>X</label>
          <input type="range" id="txSlider" min="-100" max="100" step="0.5" value="0" />
          <span class="val" id="txVal">0.0</span>
        </div>
        <div class="affine-slider">
          <label>Y</label>
          <input type="range" id="tySlider" min="-100" max="100" step="0.5" value="0" />
          <span class="val" id="tyVal">0.0</span>
        </div>
        <div class="affine-slider">
          <label>Z</label>
          <input type="range" id="tzSlider" min="-100" max="100" step="0.5" value="0" />
          <span class="val" id="tzVal">0.0</span>
        </div>
      </div>
      <div class="affine-group">
        <label>Rotate (deg):</label>
        <div class="affine-slider">
          <label>X</label>
          <input type="range" id="rxSlider" min="-180" max="180" step="1" value="0" />
          <span class="val" id="rxVal">0</span>
        </div>
        <div class="affine-slider">
          <label>Y</label>
          <input type="range" id="rySlider" min="-180" max="180" step="1" value="0" />
          <span class="val" id="ryVal">0</span>
        </div>
        <div class="affine-slider">
          <label>Z</label>
          <input type="range" id="rzSlider" min="-180" max="180" step="1" value="0" />
          <span class="val" id="rzVal">0</span>
        </div>
      </div>
      <div class="affine-group">
        <label>Scale:</label>
        <div class="affine-slider">
          <label>X</label>
          <input type="range" id="sxSlider" min="0.5" max="2.0" step="0.01" value="1.0" />
          <span class="val" id="sxVal">1.00</span>
        </div>
        <div class="affine-slider">
          <label>Y</label>
          <input type="range" id="sySlider" min="0.5" max="2.0" step="0.01" value="1.0" />
          <span class="val" id="syVal">1.00</span>
        </div>
        <div class="affine-slider">
          <label>Z</label>
          <input type="range" id="szSlider" min="0.5" max="2.0" step="0.01" value="1.0" />
          <span class="val" id="szVal">1.00</span>
        </div>
      </div>
    </div>
    <main id="canvas-container">
      <div style="display: flex; width: 100%; height: 100%">
        <canvas id="gl1"></canvas>
      </div>
    </main>
    <footer>
      <label id="statusBar">Enter a zarr store URL and click Load</label>
    </footer>
  </body>
</html>
<script type="module" async>
  import { Niivue, DRAG_MODE, SLICE_TYPE, SHOW_RENDER, MULTIPLANAR_TYPE, copyAffine } from './niivue/index.ts'

  const storeUrlInput = document.getElementById('storeUrl')
  const maxVolSizeSelect = document.getElementById('maxVolSize')
  const zarrLevelSelect = document.getElementById('zarrLevel')
  const loadBtn = document.getElementById('loadBtn')
  const statusBar = document.getElementById('statusBar')
  const navControls = document.getElementById('navControls')
  const infoPanel = document.getElementById('infoPanel')
  const levelSelectorsContainer = document.getElementById('levelSelectorsContainer')
  const affineControls = document.getElementById('affineControls')
  const affineResetBtn = document.getElementById('affineResetBtn')
  const affineSaveBtn = document.getElementById('affineSaveBtn')
  const affineLoadBtn = document.getElementById('affineLoadBtn')

  // Affine slider elements
  const sliders = {
    tx: document.getElementById('txSlider'),
    ty: document.getElementById('tySlider'),
    tz: document.getElementById('tzSlider'),
    rx: document.getElementById('rxSlider'),
    ry: document.getElementById('rySlider'),
    rz: document.getElementById('rzSlider'),
    sx: document.getElementById('sxSlider'),
    sy: document.getElementById('sySlider'),
    sz: document.getElementById('szSlider'),
  }
  const valDisplays = {
    tx: document.getElementById('txVal'),
    ty: document.getElementById('tyVal'),
    tz: document.getElementById('tzVal'),
    rx: document.getElementById('rxVal'),
    ry: document.getElementById('ryVal'),
    rz: document.getElementById('rzVal'),
    sx: document.getElementById('sxVal'),
    sy: document.getElementById('syVal'),
    sz: document.getElementById('szVal'),
  }

  const ZARR_VOL_IDX = 1

  function applyAffineFromSliders() {
    if (nv.volumes.length <= ZARR_VOL_IDX) return
    const transform = {
      translation: [parseFloat(sliders.tx.value), parseFloat(sliders.ty.value), parseFloat(sliders.tz.value)],
      rotation: [parseFloat(sliders.rx.value), parseFloat(sliders.ry.value), parseFloat(sliders.rz.value)],
      scale: [parseFloat(sliders.sx.value), parseFloat(sliders.sy.value), parseFloat(sliders.sz.value)],
    }
    // Reset to original before applying cumulative transform
    nv.resetVolumeAffine(ZARR_VOL_IDX)
    nv.applyVolumeTransform(ZARR_VOL_IDX, transform)
  }

  function resetAffineSliders() {
    sliders.tx.value = 0; sliders.ty.value = 0; sliders.tz.value = 0
    sliders.rx.value = 0; sliders.ry.value = 0; sliders.rz.value = 0
    sliders.sx.value = 1; sliders.sy.value = 1; sliders.sz.value = 1
    for (const key of ['tx', 'ty', 'tz']) valDisplays[key].textContent = '0.0'
    for (const key of ['rx', 'ry', 'rz']) valDisplays[key].textContent = '0'
    for (const key of ['sx', 'sy', 'sz']) valDisplays[key].textContent = '1.00'
  }

  // Wire up slider input events
  for (const [key, slider] of Object.entries(sliders)) {
    slider.addEventListener('input', () => {
      const val = parseFloat(slider.value)
      if (key.startsWith('s')) {
        valDisplays[key].textContent = val.toFixed(2)
      } else if (key.startsWith('r')) {
        valDisplays[key].textContent = val.toFixed(0)
      } else {
        valDisplays[key].textContent = val.toFixed(1)
      }
      applyAffineFromSliders()
    })
  }

  affineResetBtn.addEventListener('click', () => {
    if (nv.volumes.length <= ZARR_VOL_IDX) return
    nv.resetVolumeAffine(ZARR_VOL_IDX)
    resetAffineSliders()
  })

  function getZarrUrl() {
    if (nv.volumes.length <= ZARR_VOL_IDX) return null
    return nv.volumes[ZARR_VOL_IDX].url || storeUrlInput.value.trim()
  }

  function getSliderValues() {
    return {
      tx: parseFloat(sliders.tx.value), ty: parseFloat(sliders.ty.value), tz: parseFloat(sliders.tz.value),
      rx: parseFloat(sliders.rx.value), ry: parseFloat(sliders.ry.value), rz: parseFloat(sliders.rz.value),
      sx: parseFloat(sliders.sx.value), sy: parseFloat(sliders.sy.value), sz: parseFloat(sliders.sz.value),
    }
  }

  function setSliderValues(vals) {
    for (const key of Object.keys(sliders)) {
      sliders[key].value = vals[key]
      const v = vals[key]
      if (key.startsWith('s')) valDisplays[key].textContent = v.toFixed(2)
      else if (key.startsWith('r')) valDisplays[key].textContent = v.toFixed(0)
      else valDisplays[key].textContent = v.toFixed(1)
    }
  }

  affineSaveBtn.addEventListener('click', () => {
    const url = getZarrUrl()
    if (!url) return
    const vals = getSliderValues()
    localStorage.setItem(url, JSON.stringify(vals))
    statusBar.textContent = `Affine saved for ${url}`
  })

  affineLoadBtn.addEventListener('click', () => {
    const url = getZarrUrl()
    if (!url) return
    const stored = localStorage.getItem(url)
    if (!stored) {
      statusBar.textContent = `No saved affine found for ${url}`
      return
    }
    const vals = JSON.parse(stored)
    setSliderValues(vals)
    applyAffineFromSliders()
    statusBar.textContent = `Affine loaded for ${url}`
  })

  // Create NiiVue instance
  const nv = new Niivue({
    show3Dcrosshair: true,
    logLevel: 'debug',
    dragMode: DRAG_MODE.pan,
    isColorbar: true,
    isOrientCube: true,
    backColor: [0.5, 0.5, 0.5, 1],
    multiplanarLayout: MULTIPLANAR_TYPE.GRID,
    // isSliceMM: true
  })

  await nv.attachToCanvas(document.getElementById('gl1'))
  nv.opts.multiplanarShowRender = SHOW_RENDER.ALWAYS
  window.nv = nv

  function updateInfoPanel() {
    const helper = nv.getZarrVolume()?.zarrHelper
    if (!helper) {
      infoPanel.style.display = 'none'
      return
    }

    const state = helper.getViewportState()
    const pyramidInfo = helper.getPyramidInfo()
    const volDims = helper.getVolumeDims()
    const levelDims = helper.getLevelDims()

    const level0Dims = pyramidInfo.levels[0].shape
    const currentLevel = pyramidInfo.levels[state.level]

    const wasHidden = infoPanel.style.display === 'none' || infoPanel.style.display === ''
    infoPanel.style.display = 'block'
    infoPanel.innerHTML = `
      <strong>Dataset:</strong> ${pyramidInfo.name}<br>
      <strong>Full size:</strong> ${level0Dims.join(' x ')} (${pyramidInfo.is3D ? '3D' : '2D'})<br>
      <strong>Pyramid levels:</strong> ${pyramidInfo.levels.length}<br>
      <strong>Current level:</strong> ${state.level} (${currentLevel.shape.join(' x ')})<br>
      <strong>Center:</strong> X=${state.centerX.toFixed(1)}, Y=${state.centerY.toFixed(1)}, Z=${state.centerZ.toFixed(1)}<br>
      <strong>Virtual volume:</strong> ${volDims.width} x ${volDims.height} x ${volDims.depth}
    `
    if (wasHidden) {
      nv.resizeListener()
    }
  }

  // Create level selectors for all zarr volumes
  function createLevelSelectors() {
    levelSelectorsContainer.innerHTML = ''
    const zarrVolumes = nv.getZarrVolumes()

    if (zarrVolumes.length === 0) return

    zarrVolumes.forEach((vol, volIdx) => {
      const helper = vol.zarrHelper
      if (!helper) return

      const pyramidInfo = helper.getPyramidInfo()
      const currentLevel = helper.getPyramidLevel()

      // Create container for this volume's level selector
      const selectorDiv = document.createElement('div')
      selectorDiv.className = 'level-selector'

      // Create label
      const label = document.createElement('label')
      const volName = pyramidInfo.name || `Zarr ${volIdx + 1}`
      label.textContent = `${volName}:`
      selectorDiv.appendChild(label)

      // Create select element
      const select = document.createElement('select')
      select.dataset.volumeIndex = volIdx

      pyramidInfo.levels.forEach((lvl, idx) => {
        const option = document.createElement('option')
        option.value = idx
        option.textContent = `${idx}: ${lvl.shape.join('x')}`
        if (idx === currentLevel) {
          option.selected = true
        }
        select.appendChild(option)
      })

      // Add change handler for this select
      select.addEventListener('change', async () => {
        const targetVolIdx = parseInt(select.dataset.volumeIndex)
        const targetVol = nv.getZarrVolumes()[targetVolIdx]
        if (!targetVol?.zarrHelper) return

        const level = parseInt(select.value)
        await targetVol.zarrHelper.setPyramidLevel(level)
        nv.updateGLVolume()
        nv.drawScene()
        updateInfoPanel()
      })

      selectorDiv.appendChild(select)
      levelSelectorsContainer.appendChild(selectorDiv)
    })
  }

  // Load button handler
  loadBtn.addEventListener('click', async () => {
    const storeUrl = storeUrlInput.value.trim()
    if (!storeUrl) {
      alert('Please enter a zarr store URL')
      return
    }

    const maxVolSize = parseInt(maxVolSizeSelect.value)
    const level = parseInt(zarrLevelSelect.value)

    loadBtn.disabled = true
    loadBtn.textContent = 'Loading...'
    statusBar.textContent = 'Discovering zarr structure...'

    try {
      await nv.loadVolumes([
        // mni zarr (LSM simulated)
        {
          // url: storeUrl,
          url: "http://localhost:8080/mni152.ome.zarr",
          zarrLevel: level,
          zarrMaxVolumeSize: maxVolSize,
          opacity: 1.0,
          colormap: "grey"
        },
        // mni nifti
        { url: "../demos/images/mni152.nii.gz", opacity: 1,colormap: "gray" }, 
        // mni WSI image
        {
          // url: storeUrl,
          url: "http://localhost:8080/mni152_axial.ome.zarr",
          // url: "http://localhost:3000/K_HE_2_ome.zarr",
          // url: "http://localhost:3000/E23191_25-1A.1.ome.zarr",
          zarrLevel: level,
          zarrMaxVolumeSize: maxVolSize,
          channel: 0,
          opacity: 1.0,
          colormap: "red"
        },
        // {
        //   url: "http://localhost:3000/export/nifti?zarr_path=K_HE_2_ome.zarr&scale=virtual_scale1&c=0&z=0&y=0&x=0&xdim=128&ydim=128&zdim=128",
        //   name: "nifti.nii.gz"
        // }
        // LSM image
        // {
        //   // url: storeUrl,
        //   // url: "http://localhost:8080/mni152_axial.ome.zarr",
        //   url: "http://localhost:3000/K_HE_2_ome.zarr",
        //   // url: "https://dandiarchive.s3.amazonaws.com/zarr/7723d02f-1f71-4553-a7b0-47bda1ae8b42",
        //   // url: "http://localhost:3000/E23191_25-1A.1.ome.zarr",
        //   // url: "http://localhost:3000/test-image.zarr",
        //   zarrLevel: level,
        //   zarrMaxVolumeSize: maxVolSize,
        //   opacity: 1.0,
        //   colormap: "gray"
        // },
        
        
      ])
      // await nv.addVolumeFromUrl({ url: "../demos/images/mni152.nii.gz", opacity: 0.4,colormap: "red" })
      // nv.setColormap(nv.volumes[0].id, 'gray')

      // Show navigation and affine controls
      navControls.style.display = 'flex'
      affineControls.style.display = 'block'
      resetAffineSliders()

      // Create level selectors for all zarr volumes
      createLevelSelectors()

      const zarrVolumes = nv.getZarrVolumes()
      if (zarrVolumes.length > 0) {
        const statusParts = zarrVolumes.map((vol, idx) => {
          const helper = vol.zarrHelper
          if (!helper) return ''
          const pyramidInfo = helper.getPyramidInfo()
          const state = helper.getViewportState()
          const dims = pyramidInfo.levels[state.level].shape
          const name = pyramidInfo.name || `Zarr ${idx + 1}`
          return `${name}: L${state.level + 1}/${pyramidInfo.levels.length}`
        }).filter(s => s).join(' | ')
        statusBar.textContent = statusParts
        updateInfoPanel()
      }
    } catch (err) {
      console.error('Failed to load Zarr:', err)
      statusBar.textContent = `Error: ${err.message}`
      navControls.style.display = 'none'
      infoPanel.style.display = 'none'
      affineControls.style.display = 'none'
    } finally {
      loadBtn.disabled = false
      loadBtn.textContent = 'Load Zarr'
    }
  })

  console.log(`
  Zarr Viewer Controls:
  - Left-click drag: Pan the view
  - Level dropdown: Switch pyramid level
  - Standard NiiVue controls for slice navigation

  Uses standard loadVolumes() API with zarrLevel option.
  `)
</script>
