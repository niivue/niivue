<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0" />
    <title>NiiVue - Zarr Viewer</title>
    <link rel="stylesheet" href="niivue.css" />
    <link rel="icon" href="data:;base64,iVBORw0KGgo=" />
    <style>
      #controls {
        display: flex;
        gap: 16px;
        align-items: center;
        padding: 8px;
        background: #2a2a2a;
        flex-wrap: wrap;
      }
      #controls label {
        color: #ccc;
      }
      #controls input,
      #controls select {
        padding: 4px 8px;
      }
      #loadBtn {
        background: #4a9eff;
        border: none;
        color: white;
        padding: 8px 16px;
        cursor: pointer;
        border-radius: 4px;
      }
      #loadBtn:hover {
        background: #3a8eef;
      }
      #loadBtn:disabled {
        background: #666;
        cursor: not-allowed;
      }
      #navControls {
        display: none;
        gap: 8px;
        align-items: center;
      }
      #navControls button {
        background: #444;
        border: 1px solid #666;
        color: white;
        padding: 4px 12px;
        cursor: pointer;
        border-radius: 4px;
      }
      #navControls button:hover {
        background: #555;
      }
      #infoPanel {
        padding: 8px;
        background: #1a1a2e;
        color: #aaa;
        font-family: monospace;
        font-size: 12px;
        display: none;
      }
      .hint {
        color: #888;
        font-size: 11px;
        font-style: italic;
      }
    </style>
  </head>
  <body>
    <header>
      <div id="controls">
        <label for="storeUrl">Zarr URL:</label>
        <input
          type="text"
          id="storeUrl"
          value="https://ome-zarr-scivis.s3.us-east-1.amazonaws.com/v0.5/96x2/pawpawsaurus.ome.zarr"
          style="width: 400px"
        />
        <!-- https://ome-zarr-scivis.s3.us-east-1.amazonaws.com/v0.5/96x2/pawpawsaurus.ome.zarr -->
         <!-- https://ome-zarr-scivis.s3.us-east-1.amazonaws.com/v0.5/96x2/chameleon.ome.zarr -->

        <label for="maxVolSize">Max Volume Size:</label>
        <select id="maxVolSize">
          <option value="128">128</option>
          <option value="256" selected>256</option>
          <option value="512">512</option>
        </select>

        <label for="zarrLevel">Level:</label>
        <select id="zarrLevel">
          <option value="0" selected>0 (highest res)</option>
          <option value="1">1</option>
          <option value="2">2</option>
          <option value="3">3</option>
          <option value="4">4</option>
          <option value="5">5</option>
        </select>

        <button id="loadBtn">Load Zarr</button>

        <div id="navControls">
          <span class="hint">Drag to pan</span>
          <label for="levelSelect">Switch level:</label>
          <select id="levelSelect"></select>
        </div>
      </div>
    </header>
    <div id="infoPanel"></div>
    <main id="canvas-container">
      <div style="display: flex; width: 100%; height: 100%">
        <canvas id="gl1"></canvas>
      </div>
    </main>
    <footer>
      <label id="statusBar">Enter a zarr store URL and click Load</label>
    </footer>
  </body>
</html>
<script type="module" async>
  import { Niivue, DRAG_MODE, SLICE_TYPE, SHOW_RENDER, MULTIPLANAR_TYPE } from './niivue/index.ts'

  const storeUrlInput = document.getElementById('storeUrl')
  const maxVolSizeSelect = document.getElementById('maxVolSize')
  const zarrLevelSelect = document.getElementById('zarrLevel')
  const loadBtn = document.getElementById('loadBtn')
  const statusBar = document.getElementById('statusBar')
  const navControls = document.getElementById('navControls')
  const infoPanel = document.getElementById('infoPanel')
  const levelSelect = document.getElementById('levelSelect')

  // Create NiiVue instance
  const nv = new Niivue({
    show3Dcrosshair: true,
    logLevel: 'debug',
    dragMode: DRAG_MODE.pan,
    isColorbar: true,
    isOrientCube: true,
    backColor: [0.1, 0.1, 0.15, 1],
    multiplanarLayout: MULTIPLANAR_TYPE.GRID
  })

  await nv.attachToCanvas(document.getElementById('gl1'))
  nv.opts.multiplanarShowRender = SHOW_RENDER.ALWAYS
  window.nv = nv

  function updateInfoPanel() {
    const helper = nv.back?.zarrHelper
    if (!helper) {
      infoPanel.style.display = 'none'
      return
    }

    const state = helper.getViewportState()
    const pyramidInfo = helper.getPyramidInfo()
    const volDims = helper.getVolumeDims()
    const levelDims = helper.getLevelDims()

    const level0Dims = pyramidInfo.levels[0].shape
    const currentLevel = pyramidInfo.levels[state.level]

    const wasHidden = infoPanel.style.display === 'none' || infoPanel.style.display === ''
    infoPanel.style.display = 'block'
    infoPanel.innerHTML = `
      <strong>Dataset:</strong> ${pyramidInfo.name}<br>
      <strong>Full size:</strong> ${level0Dims.join(' x ')} (${pyramidInfo.is3D ? '3D' : '2D'})<br>
      <strong>Pyramid levels:</strong> ${pyramidInfo.levels.length}<br>
      <strong>Current level:</strong> ${state.level} (${currentLevel.shape.join(' x ')})<br>
      <strong>Center:</strong> X=${state.centerX.toFixed(1)}, Y=${state.centerY.toFixed(1)}, Z=${state.centerZ.toFixed(1)}<br>
      <strong>Virtual volume:</strong> ${volDims.width} x ${volDims.height} x ${volDims.depth}
    `
    if (wasHidden) {
      nv.resizeListener()
    }
  }

  // Manual level select handler
  levelSelect.addEventListener('change', async () => {
    const helper = nv.back?.zarrHelper
    if (!helper) return
    const level = parseInt(levelSelect.value)
    await helper.setPyramidLevel(level)
    nv.updateGLVolume()
    nv.drawScene()
    updateInfoPanel()
  })

  // Load button handler
  loadBtn.addEventListener('click', async () => {
    const storeUrl = storeUrlInput.value.trim()
    if (!storeUrl) {
      alert('Please enter a zarr store URL')
      return
    }

    const maxVolSize = parseInt(maxVolSizeSelect.value)
    const level = parseInt(zarrLevelSelect.value)

    loadBtn.disabled = true
    loadBtn.textContent = 'Loading...'
    statusBar.textContent = 'Discovering zarr structure...'

    try {
      // Use standard loadVolumes API
      await nv.loadVolumes([
        { url: "../demos/images/mni152.nii.gz" }, 
        {
          url: storeUrl,
          zarrLevel: level,
          zarrMaxVolumeSize: maxVolSize,
          cal_min: 30_000,
          cal_max: 50_000
        },
      ])
      nv.setColormap(nv.volumes[0].id, 'gray')

      // Show navigation controls
      navControls.style.display = 'flex'

      const helper = nv.back?.zarrHelper
      if (helper) {
        const pyramidInfo = helper.getPyramidInfo()
        levelSelect.innerHTML = ''
        pyramidInfo.levels.forEach((lvl, idx) => {
          const option = document.createElement('option')
          option.value = idx
          option.textContent = `${idx}: ${lvl.shape.join('x')}`
          if (idx === helper.getPyramidLevel()) {
            option.selected = true
          }
          levelSelect.appendChild(option)
        })

        const state = helper.getViewportState()
        const dims = pyramidInfo.levels[state.level].shape
        statusBar.textContent = `Level ${state.level + 1}/${pyramidInfo.levels.length} (${dims.join(' x ')})`
        updateInfoPanel()
      }
    } catch (err) {
      console.error('Failed to load Zarr:', err)
      statusBar.textContent = `Error: ${err.message}`
      navControls.style.display = 'none'
      infoPanel.style.display = 'none'
    } finally {
      loadBtn.disabled = false
      loadBtn.textContent = 'Load Zarr'
    }
  })

  console.log(`
  Zarr Viewer Controls:
  - Left-click drag: Pan the view
  - Level dropdown: Switch pyramid level
  - Standard NiiVue controls for slice navigation

  Uses standard loadVolumes() API with zarrLevel option.
  `)
</script>
